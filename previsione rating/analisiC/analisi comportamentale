import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# 1. Caricamento Dati ROBUSTO (combinando train e test per un'analisi completa)
try:
    df_train = pd.read_csv('drugLibTrain_final_v3.tsv', sep='\t')
    df_test = pd.read_csv('drugLibTest_final_v3.tsv', sep='\t')
except FileNotFoundError:
    try:
        # Fallback se non trova il file v3, prova con quello pulito o raw
        df_train = pd.read_csv('drugLibTrain_final_clean.tsv', sep='\t')
        df_test = pd.read_csv('drugLibTest_final_clean.tsv', sep='\t')
    except:
        df_train = pd.read_csv('drugLibTrain_raw.tsv', sep='\t')
        df_test = pd.read_csv('drugLibTest_raw.tsv', sep='\t')

# Concatenazione per massima statistica
df = pd.concat([df_train, df_test], ignore_index=True)

# Gestione nomi colonne variabili (cercando la colonna pulita)
if 'condition_standardized_v3' in df.columns:
    cond_col = 'condition_standardized_v3'
elif 'condition_standardized' in df.columns:
    cond_col = 'condition_standardized'
else:
    cond_col = 'condition'

# Mapping Ordinale
eff_map = {
    'Ineffective': 1, 'Marginally Effective': 2, 'Moderately Effective': 3,
    'Considerably Effective': 4, 'Highly Effective': 5
}
side_map = {
    'No Side Effects': 1, 'Mild Side Effects': 2, 'Moderate Side Effects': 3,
    'Severe Side Effects': 4, 'Extremely Severe Side Effects': 5
}

df['eff_score'] = df['effectiveness'].map(eff_map)
df['side_score'] = df['sideEffects'].map(side_map)

# Pulizia
df_clean = df.dropna(subset=['rating', 'side_score', cond_col])

# 2. Calcolo Indice di Tolleranza per TUTTE le condizioni possibili (N >= 5)
condition_stats = df_clean.groupby(cond_col).filter(lambda x: len(x) >= 5)

analysis_data = []

for cond, data in condition_stats.groupby(cond_col):
    correlation = data['side_score'].corr(data['rating'])
    avg_rating = data['rating'].mean()
    count = len(data)
    
    # Assegnazione Cluster (Definizione logica)
    if correlation < -0.75:
        cluster = 'Intolleranti'
    elif correlation > -0.45:
        cluster = 'Stoici'
    else:
        cluster = 'Neutri'

    if pd.isna(correlation):
        continue
        
    analysis_data.append({
        'Condizione': cond,
        'Indice_Tolleranza': correlation,
        'Rating_Medio': avg_rating,
        'N_Recensioni': count,
        'Cluster': cluster
    })

plot_df = pd.DataFrame(analysis_data)
total_conditions_analyzed = len(plot_df)

# --- 3. GENERAZIONE DELLE VISUALIZZAZIONI DISTINTE ---

# Palette standard (per coerenza tra i 3 grafici)
cluster_palette = {'Intolleranti': '#e74c3c', 'Neutri': '#f1c40f', 'Stoici': '#2ecc71'}


# VIZ 1: SCATTERPLOT GLOBALE (Mappa dei Profili)
plt.figure(figsize=(12, 8))
sns.scatterplot(
    data=plot_df, 
    x='Indice_Tolleranza', 
    y='Rating_Medio', 
    hue='Cluster',
    size='N_Recensioni',
    sizes=(20, 400),
    palette=cluster_palette,
    alpha=0.6,
    edgecolor='black',
    linewidth=0.5
)
plt.title(f'1. Mappa Globale dei Profili di Tolleranza ({total_conditions_analyzed} Condizioni)', fontsize=14, fontweight='bold')
plt.xlabel('Indice di Tolleranza (Correlazione Effetti Collaterali vs Rating)', fontsize=12)
plt.ylabel('Rating Medio Complessivo (1-10)', fontsize=12)
plt.axvline(x=-0.75, color='grey', linestyle='--', alpha=0.3)
plt.axvline(x=-0.45, color='grey', linestyle='--', alpha=0.3)
plt.legend(bbox_to_anchor=(1.01, 1), loc='upper left')
plt.tight_layout()
plt.savefig('viz1_mappa_tolleranza.png', dpi=300)

