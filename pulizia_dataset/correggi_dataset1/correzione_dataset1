import pandas as pd
import numpy as np

# Funzione che contiene tutta la logica di pulizia
def clean_condition_column(df):
    # Lavoriamo su una copia per evitare avvisi di sistema
    df = df.copy()
    
    # 1. Normalizzazione
    df['condition'] = df['condition'].str.lower().str.strip()

    # 2. Standardizzazione dei Separatori
    df['condition'] = df['condition'].str.replace(' and ', '|', regex=False)
    df['condition'] = df['condition'].str.replace(' & ', '|', regex=False)
    df['condition'] = df['condition'].str.replace('/', '|', regex=False)
    df['condition'] = df['condition'].str.replace(',', '|', regex=False)
    
    # --- NUOVA RIGA AGGIUNTA ---
    # Sostituisce il trattino solo se circondato da spazi (es. "insomnia - anxiety")
    # Questo protegge parole composte come "bi-polar" o "anti-aging"
    df['condition'] = df['condition'].str.replace(' - ', '|', regex=False)
    # ---------------------------
    
    # Rimuove spazi extra attorno ai pipe
    df['condition'] = df['condition'].str.replace(r'\s*\|\s*', '|', regex=True)

    # 3. Splitting
    df['condition'] = df['condition'].str.split('|')

    # 4. Esplosione (Explode)
    df_exploded = df.explode('condition')

    # 5. Pulizia Finale
    df_exploded['condition'] = df_exploded['condition'].str.strip()
    
    # Rimuove righe vuote o NaN generate dallo split
    df_exploded = df_exploded[df_exploded['condition'].astype(bool)]
    df_exploded = df_exploded.dropna(subset=['condition'])
    
    return df_exploded.reset_index(drop=True)

# --- ESECUZIONE PRINCIPALE ---

# 1. Carica ed elabora il file TRAIN
print("Elaborazione del file TRAIN...")
try:
    df_train = pd.read_csv('drugLibTrain_raw.tsv', sep='\t')
    df_train_clean = clean_condition_column(df_train)
    # Salva il file TRAIN pulito
    df_train_clean.to_csv('drugLibTrain_cleaned.tsv', index=False, sep='\t')
    print(f"Fatto. Righe Train: {len(df_train)} -> {len(df_train_clean)}")
except FileNotFoundError:
    print("Errore: File 'drugLibTrain_raw.tsv' non trovato.")


# 2. Carica ed elabora il file TEST
print("\nElaborazione del file TEST...")
try:
    df_test = pd.read_csv('drugLibTest_raw.tsv', sep='\t')
    df_test_clean = clean_condition_column(df_test)
    # Salva il file TEST pulito
    df_test_clean.to_csv('drugLibTest_cleaned.tsv', index=False, sep='\t')
    print(f"Fatto. Righe Test: {len(df_test)} -> {len(df_test_clean)}")
except FileNotFoundError:
    print("Errore: File 'drugLibTest_raw.tsv' non trovato.")

print("\nOperazione completata! Hai due file separati pronti all'uso.")