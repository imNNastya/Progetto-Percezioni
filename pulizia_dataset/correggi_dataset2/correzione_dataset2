import pandas as pd
import re

# Funzione di standardizzazione
def standardize_condition_text(text):
    if not isinstance(text, str):
        return text
    
    text = text.lower().strip()
    
    # Regole di mapping (l'ordine è importante!)
    
    # Salute Mentale
    if re.search(r'depress|dysthymi|low mood|sad', text): return 'depression'
    if re.search(r'bipolar|manic|mania|mood swing', text): return 'bipolar disorder'
    if re.search(r'anxiet|panic|nervous|stress|fear|phobia|gad', text): return 'anxiety disorders'
    if re.search(r'\badd\b|adhd|attention|focus|concentrat', text): return 'adhd/add'
    if re.search(r'somni|sleep|wake|restless', text): return 'sleep disorders'
    if re.search(r'schizo|psychosis|delusion', text): return 'psychotic disorders'

    # Condizioni Fisiche Comuni
    if re.search(r'acne|pimple|blackhead|spot', text): return 'acne'
    if re.search(r'blood pressure|hypertens|htn|high bp', text): return 'hypertension'
    if re.search(r'cholesterol|lipid|ldl|hdl', text): return 'high cholesterol'
    if re.search(r'diabet|sugar|insulin', text): return 'diabetes'
    if re.search(r'thyroid|hashimoto|graves', text): return 'thyroid disorder'
    if re.search(r'reflux|gerd|heartburn|acid|indigestion|stomach|ulcer', text): return 'gastrointestinal issues'
    if re.search(r'allerg|hay fever|rhinitis|hives', text): return 'allergies'
    if re.search(r'asthma|breath|pulmonary', text): return 'asthma/copd'

    # Dolore e Infiammazione
    if re.search(r'migraine|headache', text): return 'migraine/headache'
    if re.search(r'fibromyalgia', text): return 'fibromyalgia'
    if re.search(r'arthriti|joint|osteo|rheum', text): return 'arthritis'
    if re.search(r'pain|ache|back|neck|sciatica', text): return 'pain (chronic/acute)'

    # Infezioni
    if re.search(r'uti|urinary|bladder|cystitis', text): return 'urinary tract infection'
    if re.search(r'sinus|nasal', text): return 'sinusitis/nasal issues'
    if re.search(r'bronchitis|pneumonia|respiratory|cough|throat|chest', text): return 'respiratory infection'
    if re.search(r'fungus|fungal|yeast|candid|tinea', text): return 'fungal infection'
    if re.search(r'herpes|cold sore|hsv', text): return 'herpes/cold sores'
    if re.search(r'bacteri|infect|abscess', text): return 'infection (general)'

    # Altro
    if re.search(r'eczema|dermatitis|psoriasis|rash|skin', text): return 'skin condition (non-acne)'
    if re.search(r'menopaus|hot flash|hormon|estrogen', text): return 'menopause/hormonal'
    if re.search(r'birth control|contracept|pregnan|period|menstru', text): return 'contraception/menstrual'
    if re.search(r'weight|obes|fat', text): return 'weight management'
    if re.search(r'smok|nicotine|tobacco|quit', text): return 'smoking cessation'
    if re.search(r'fatigu|tired|letharg|energy', text): return 'fatigue'

    return text # Ritorna il testo originale se non trova match

# --- ESECUZIONE ---

# 1. Carica i file "puliti" (generati dallo step precedente)
file_train = 'drugLibTrain_cleaned.tsv' 
file_test = 'drugLibTest_cleaned.tsv'

try:
    df_train = pd.read_csv(file_train, sep='\t')
    df_test = pd.read_csv(file_test, sep='\t')
    
    print("File caricati correttamente.")

    # 2. Applica la standardizzazione
    df_train['condition_standardized'] = df_train['condition'].apply(standardize_condition_text)
    df_test['condition_standardized'] = df_test['condition'].apply(standardize_condition_text)

    # 3. Mostra i risultati
    print(f"Condizioni uniche originali (Train): {df_train['condition'].nunique()}")
    print(f"Condizioni uniche standardizzate (Train): {df_train['condition_standardized'].nunique()}")
    
    print("\nEsempio delle categorie più frequenti dopo la standardizzazione:")
    print(df_train['condition_standardized'].value_counts().head(10))

    # 4. Salva i file finali pronti per il clustering
    df_train.to_csv('drugLibTrain_final.tsv', index=False, sep='\t')
    df_test.to_csv('drugLibTest_final.tsv', index=False, sep='\t')
    print("\nFile finali salvati: 'drugLibTrain_final.tsv' e 'drugLibTest_final.tsv'")

except FileNotFoundError:
    print("Errore: Assicurati di aver eseguito prima lo script di pulizia e che i file _cleaned.tsv esistano.")